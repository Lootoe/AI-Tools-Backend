// Prisma Schema for AI Tools
// 使用 PostgreSQL 数据库

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nickname  String?
  avatar    String?
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  balanceRecords BalanceRecord[]

  @@map("users")
}

// 余额记录
model BalanceRecord {
  id          String   @id @default(cuid())
  userId      String
  type        String   // consume | recharge | refund | invite | redeem
  amount      Int      // 正数为增加，负数为减少
  balance     Int      // 变动后余额
  description String   // 描述
  relatedId   String?  // 关联ID，如任务ID
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("balance_records")
}

// 邮箱验证码
model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String   // register | reset_password
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, type])
  @@map("verification_codes")
}

// 剧本
model Script {
  id           String    @id @default(cuid())
  title        String
  prompt       String?   // 生成剧本的提示词
  content      String?   // 剧本内容
  currentPhase String    @default("storyboard") // storyboard | video
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  episodes   Episode[]
  characters Character[]

  @@map("scripts")
}

// 剧集
model Episode {
  id            String   @id @default(cuid())
  scriptId      String
  episodeNumber Int
  title         String
  content       String   // 剧集内容
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  script      Script       @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  storyboards Storyboard[]

  @@map("episodes")
}

// 分镜
model Storyboard {
  id                 String   @id @default(cuid())
  episodeId          String
  sceneNumber        Int
  description        String
  referenceImageUrls String[] // 参考图URL数组
  referenceImageUrl  String?  // 参考图URL（单张）
  activeVariantId    String?  // 当前选中的副本ID
  createdAt          DateTime @default(now())
  // 兼容旧数据
  videoUrl           String?
  thumbnailUrl       String?
  taskId             String?
  progress           String?
  status             String   @default("pending")

  episode  Episode             @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  variants StoryboardVariant[]

  @@map("storyboards")
}

// 分镜副本
model StoryboardVariant {
  id           String    @id @default(cuid())
  storyboardId String
  videoUrl     String?
  thumbnailUrl String?
  taskId       String?
  progress     String?
  status       String    @default("pending") // pending | queued | generating | completed | failed
  failReason   String?   // 生成失败原因
  userId       String?   // 创建者用户ID，用于失败时返还代币
  tokenCost    Int?      // 消耗的代币数量
  startedAt    DateTime? // 生成开始时间
  finishedAt   DateTime? // 生成结束时间（完成或失败）
  createdAt    DateTime  @default(now())

  storyboard Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@map("storyboard_variants")
}

// 统一资产模型
model Asset {
  id                 String   @id @default(cuid())
  scriptId           String
  name               String
  description        String   // 资产设定/信息
  designImageUrl     String?  // 设计稿图片URL
  thumbnailUrl       String?  // 缩略图
  referenceImageUrls String[] // 参考图URL数组
  status             String   @default("pending") // pending | generating | completed | failed
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([scriptId])
  @@map("assets")
}

// 画布（每个剧本一个）
model Canvas {
  id        String   @id @default(cuid())
  scriptId  String   @unique
  viewport  Json?    // { x, y, zoom } 画布视口状态
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nodes CanvasNode[]
  edges CanvasEdge[]

  @@map("canvases")
}

// 画布节点
model CanvasNode {
  id         String   @id @default(cuid())
  canvasId   String
  type       String   // generator | input
  positionX  Float    // 节点X坐标
  positionY  Float    // 节点Y坐标
  // 节点数据
  label      String?  // 节点标签/名称
  model      String?  // AI模型（生成节点用）
  prompt     String?  // 提示词（生成节点用）
  aspectRatio String? // 图片比例
  imageSize  String?  // 图片质量 1K | 2K
  imageUrl   String?  // 生成的图片URL / 上传的图片URL
  status     String   @default("idle") // idle | generating | completed | failed
  progress   String?  // 生成进度
  failReason String?  // 失败原因
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  canvas      Canvas       @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  sourceEdges CanvasEdge[] @relation("SourceNode")
  targetEdges CanvasEdge[] @relation("TargetNode")

  @@index([canvasId])
  @@map("canvas_nodes")
}

// 画布连接
model CanvasEdge {
  id           String   @id @default(cuid())
  canvasId     String
  sourceNodeId String
  targetNodeId String
  createdAt    DateTime @default(now())

  canvas     Canvas     @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  sourceNode CanvasNode @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode CanvasNode @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@unique([sourceNodeId, targetNodeId])
  @@index([canvasId])
  @@map("canvas_edges")
}

// 资产分类（每个剧本独立）
model AssetCategory {
  id        String   @id @default(cuid())
  scriptId  String
  name      String
  sortOrder Int      @default(0)
  isDefault Boolean  @default(false) // 是否为预设分类
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  savedAssets SavedAsset[]

  @@index([scriptId])
  @@map("asset_categories")
}

// 已保存的资产
model SavedAsset {
  id           String   @id @default(cuid())
  categoryId   String
  imageUrl     String
  thumbnailUrl String?
  name         String?
  sourceNodeId String?  // 来源节点ID
  createdAt    DateTime @default(now())

  category AssetCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@map("saved_assets")
}

// Sora2角色
model Character {
  id                    String   @id @default(cuid())
  scriptId              String
  name                  String   // 角色姓名
  description           String   // 角色设定
  referenceImageUrl     String?  // 参考图URL（1张）
  videoUrl              String?  // 生成的角色视频
  thumbnailUrl          String?  // 视频缩略图
  taskId                String?  // Sora2任务ID（用于轮询）
  progress              String?  // 生成进度
  status                String   @default("pending") // pending | queued | generating | completed | failed
  failReason            String?  // 生成失败原因
  userId                String?  // 用于失败时返还代币
  tokenCost             Int?
  // Sora2 角色注册信息（视频生成完成后可注册，用于多视频角色一致性）
  soraCharacterId       String?  // Sora2 角色ID (ch_xxx)
  soraUsername          String?  // Sora2 用户名
  soraPermalink         String?  // Sora2 角色主页链接
  soraProfilePictureUrl String?  // Sora2 角色头像URL
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@index([scriptId])
}
