// Prisma Schema for AI Tools
// 使用 PostgreSQL 数据库

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nickname  String?
  avatar    String?
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  balanceRecords BalanceRecord[]

  @@map("users")
}

// 余额记录
model BalanceRecord {
  id          String   @id @default(cuid())
  userId      String
  type        String   // consume | recharge | refund | invite | redeem
  amount      Int      // 正数为增加，负数为减少
  balance     Int      // 变动后余额
  description String   // 描述
  relatedId   String?  // 关联ID，如任务ID
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("balance_records")
}

// 邮箱验证码
model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String   // register | reset_password
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, type])
  @@map("verification_codes")
}

// 剧本
model Script {
  id           String    @id @default(cuid())
  title        String
  prompt       String?   // 生成剧本的提示词
  content      String?   // 剧本内容
  currentPhase String    @default("storyboard") // storyboard | video
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  episodes   Episode[]
  characters Character[]

  @@map("scripts")
}

// 剧集
model Episode {
  id            String   @id @default(cuid())
  scriptId      String
  episodeNumber Int
  title         String
  content       String   // 剧集内容
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  script           Script            @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  storyboards      Storyboard[]
  storyboardImages StoryboardImage[]

  @@map("episodes")
}

// 分镜
model Storyboard {
  id                 String   @id @default(cuid())
  episodeId          String
  sceneNumber        Int
  description        String
  referenceImageUrls String[] // 参考图URL数组
  referenceImageUrl  String?  // 参考图URL（单张）
  activeVariantId    String?  // 当前选中的副本ID
  createdAt          DateTime @default(now())
  // 兼容旧数据
  videoUrl           String?
  thumbnailUrl       String?
  taskId             String?
  progress           String?
  status             String   @default("pending")

  episode  Episode             @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  variants StoryboardVariant[]

  @@map("storyboards")
}

// 分镜副本
model StoryboardVariant {
  id           String   @id @default(cuid())
  storyboardId String
  videoUrl     String?
  thumbnailUrl String?
  taskId       String?
  progress     String?
  status       String   @default("pending") // pending | queued | generating | completed | failed
  userId       String?  // 创建者用户ID，用于失败时返还代币
  tokenCost    Int?     // 消耗的代币数量
  createdAt    DateTime @default(now())

  storyboard Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@map("storyboard_variants")
}

// 统一资产模型
model Asset {
  id                 String   @id @default(cuid())
  scriptId           String
  name               String
  description        String   // 资产设定/信息
  designImageUrl     String?  // 设计稿图片URL
  thumbnailUrl       String?  // 缩略图
  referenceImageUrls String[] // 参考图URL数组
  status             String   @default("pending") // pending | generating | completed | failed
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([scriptId])
  @@map("assets")
}

// 分镜图（图片版分镜）
model StoryboardImage {
  id                   String   @id @default(cuid())
  episodeId            String
  sceneNumber          Int
  description          String
  referenceImageUrls   String[] // 参考图URL数组
  aspectRatio          String?  @default("9:16") // 9:16 | 16:9 | 1:1
  activeImageVariantId String?  // 当前选中的副本ID
  createdAt            DateTime @default(now())
  // 兼容旧数据
  imageUrl             String?
  thumbnailUrl         String?
  status               String   @default("pending")
  progress             String?

  episode       Episode        @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  imageVariants ImageVariant[]

  @@map("storyboard_images")
}

// 分镜图副本
model ImageVariant {
  id                String   @id @default(cuid())
  storyboardImageId String
  imageUrl          String?
  thumbnailUrl      String?
  status            String   @default("pending") // pending | queued | generating | completed | failed
  progress          String?
  userId            String?  // 创建者用户ID，用于失败时返还代币
  tokenCost         Int?     // 消耗的代币数量
  model             String?  // 使用的模型
  createdAt         DateTime @default(now())

  storyboardImage StoryboardImage @relation(fields: [storyboardImageId], references: [id], onDelete: Cascade)

  @@map("image_variants")
}

// Sora2角色
model Character {
  id                    String   @id @default(cuid())
  scriptId              String
  name                  String   // 角色姓名
  description           String   // 角色设定
  referenceImageUrl     String?  // 参考图URL（1张）
  videoUrl              String?  // 生成的角色视频
  thumbnailUrl          String?  // 视频缩略图
  taskId                String?  // Sora2任务ID（用于轮询）
  progress              String?  // 生成进度
  status                String   @default("pending") // pending | queued | generating | completed | failed
  userId                String?  // 用于失败时返还代币
  tokenCost             Int?
  // Sora2 角色注册信息（视频生成完成后可注册，用于多视频角色一致性）
  soraCharacterId       String?  // Sora2 角色ID (ch_xxx)
  soraUsername          String?  // Sora2 用户名
  soraPermalink         String?  // Sora2 角色主页链接
  soraProfilePictureUrl String?  // Sora2 角色头像URL
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@index([scriptId])
}
