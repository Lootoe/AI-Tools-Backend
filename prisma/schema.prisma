// Prisma Schema for AI Tools
// 使用 PostgreSQL 数据库

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nickname  String?
  avatar    String?
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  balanceRecords BalanceRecord[]

  @@map("users")
}

// 余额记录
model BalanceRecord {
  id          String   @id @default(cuid())
  userId      String
  type        String   // consume | recharge | refund | invite | redeem
  amount      Int      // 正数为增加，负数为减少
  balance     Int      // 变动后余额
  description String   // 描述，如"生成角色设计稿"
  relatedId   String?  // 关联ID，如任务ID
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("balance_records")
}

// 邮箱验证码
model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String   // register | reset_password
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, type])
  @@map("verification_codes")
}

// 剧本
model Script {
  id           String      @id @default(cuid())
  title        String
  prompt       String?     // 生成剧本的提示词
  content      String?     // 剧本内容
  currentPhase String      @default("storyboard") // storyboard | video
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  episodes     Episode[]
  characters   Character[]
  scenes       Scene[]
  props        Prop[]

  @@map("scripts")
}

// 剧集
model Episode {
  id            String   @id @default(cuid())
  scriptId      String
  episodeNumber Int
  title         String
  content       String   // 剧集内容
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  script      Script       @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  storyboards Storyboard[]

  @@map("episodes")
}

// 分镜
model Storyboard {
  id                 String   @id @default(cuid())
  episodeId          String
  sceneNumber        Int
  description        String
  referenceImageUrls String[] // 参考图URL数组
  firstFrameUrl      String?  // 首帧图片URL
  aspectRatio        String?  @default("16:9") // 16:9 | 9:16
  duration           String?  @default("10") // 10 | 15
  activeVariantId    String?  // 当前选中的副本ID
  createdAt          DateTime @default(now())
  // 关联资产ID数组
  linkedCharacterIds String[] // 关联的角色ID数组
  linkedSceneIds     String[] // 关联的场景ID数组
  linkedPropIds      String[] // 关联的物品ID数组
  // 兼容旧数据
  videoUrl           String?
  thumbnailUrl       String?
  taskId             String?
  progress           String?
  status             String   @default("pending")

  episode  Episode             @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  variants StoryboardVariant[]

  @@map("storyboards")
}

// 分镜副本
model StoryboardVariant {
  id           String   @id @default(cuid())
  storyboardId String
  videoUrl     String?
  thumbnailUrl String?
  taskId       String?
  progress     String?
  status       String   @default("pending") // pending | queued | generating | completed | failed
  userId       String?  // 创建者用户ID，用于失败时返还代币
  tokenCost    Int?     // 消耗的代币数量
  createdAt    DateTime @default(now())

  storyboard Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@map("storyboard_variants")
}


// 角色资产
model Character {
  id             String   @id @default(cuid())
  scriptId       String
  name           String
  description    String   // 角色设定/信息
  designImageUrl String?  // 角色设计稿图片URL
  thumbnailUrl   String?  // 缩略图
  status         String   @default("pending") // pending | generating | completed | failed
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@map("characters")
}

// 场景资产
model Scene {
  id             String   @id @default(cuid())
  scriptId       String
  name           String
  description    String   // 场景设定/信息
  designImageUrl String?  // 场景设计稿图片URL
  thumbnailUrl   String?  // 缩略图
  status         String   @default("pending") // pending | generating | completed | failed
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@map("scenes")
}

// 物品资产
model Prop {
  id             String   @id @default(cuid())
  scriptId       String
  name           String
  description    String   // 物品设定/信息
  designImageUrl String?  // 物品设计稿图片URL
  thumbnailUrl   String?  // 缩略图
  status         String   @default("pending") // pending | generating | completed | failed
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  script Script @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@map("props")
}
